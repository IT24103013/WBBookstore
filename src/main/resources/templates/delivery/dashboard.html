<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Delivery Staff Dashboard - BookNest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-card {
            transition: transform 0.2s;
            margin-bottom: 15px;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
        <a class="navbar-brand" href="#">BookNest - Delivery Staff</a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">Welcome, <span id="username">Delivery Staff</span></span>
            <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Success/Error Messages -->
    <div id="alertContainer"></div>

    <div class="row">
        <div class="col-12">
            <h2>Delivery Staff Dashboard</h2>
            <p class="text-muted">Manage deliveries and update order status</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mt-4">
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">Assigned Orders</h5>
                    <h2 class="card-text" id="assignedCount">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning">
                <div class="card-body text-center">
                    <h5 class="card-title">Available Orders</h5>
                    <h2 class="card-text" id="availableCount">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info">
                <div class="card-body text-center">
                    <h5 class="card-title">Processing</h5>
                    <h2 class="card-text" id="processingCount">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success">
                <div class="card-body text-center">
                    <h5 class="card-title">Out for Delivery</h5>
                    <h2 class="card-text" id="deliveryCount">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Assigned Orders Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Orders to Deliver</h5>
                    <button class="btn btn-light btn-sm" onclick="loadOrders()">Refresh</button>
                </div>
                <div class="card-body">
                    <div id="assignedOrders">
                        <p class="text-muted text-center">Loading orders...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Orders Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="card-title mb-0">Available Orders for Processing</h5>
                </div>
                <div class="card-body">
                    <div id="availableOrders">
                        <p class="text-muted text-center">Loading available orders...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
    });

    function loadOrders() {
        // Load assigned orders
        fetch('/delivery/api/orders/assigned')
            .then(response => response.json())
            .then(orders => {
                displayAssignedOrders(orders);
                updateStatistics(orders, []);
            })
            .catch(error => {
                console.error('Error loading assigned orders:', error);
                document.getElementById('assignedOrders').innerHTML =
                    '<p class="text-danger text-center">Error loading orders</p>';
            });

        // Load available orders
        fetch('/delivery/api/orders/available')
            .then(response => response.json())
            .then(orders => {
                displayAvailableOrders(orders);
            })
            .catch(error => {
                console.error('Error loading available orders:', error);
                document.getElementById('availableOrders').innerHTML =
                    '<p class="text-danger text-center">Error loading available orders</p>';
            });
    }

    function displayAssignedOrders(orders) {
        const container = document.getElementById('assignedOrders');

        if (orders.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No orders assigned</p>';
            return;
        }

        container.innerHTML = orders.map(order => `
        <div class="card order-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Order #${order.orderId}</h6>
                        <p class="mb-1"><strong>Customer:</strong> ${order.customerName || 'N/A'}</p>
                        <p class="mb-1"><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                        <p class="mb-1"><strong>Address:</strong> ${order.shippingAddress || 'N/A'}</p>
                        <p class="mb-1"><strong>Amount:</strong> $${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'}</p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column h-100 justify-content-between">
                            <div>
                                <span class="badge ${getStatusBadgeClass(order.status)} status-badge">
                                    ${order.status || 'UNKNOWN'}
                                </span>
                            </div>
                            <div class="btn-group-vertical w-100">
                                ${order.status === 'PENDING' ? `
                                    <button class="btn btn-primary btn-sm mb-1" onclick="updateStatus(${order.orderId}, 'PROCESSING')">
                                        Start Processing
                                    </button>
                                ` : ''}
                                ${order.status === 'PROCESSING' ? `
                                    <button class="btn btn-warning btn-sm mb-1" onclick="updateStatus(${order.orderId}, 'OUT_FOR_DELIVERY')">
                                        Out for Delivery
                                    </button>
                                ` : ''}
                                ${order.status === 'OUT_FOR_DELIVERY' ? `
                                    <button class="btn btn-success btn-sm mb-1" onclick="updateStatus(${order.orderId}, 'DELIVERED')">
                                        Mark Delivered
                                    </button>
                                ` : ''}
                                <button class="btn btn-info btn-sm" onclick="viewOrderDetails(${order.orderId})">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    }

    function displayAvailableOrders(orders) {
        const container = document.getElementById('availableOrders');

        if (orders.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No available orders for processing</p>';
            return;
        }

        container.innerHTML = orders.map(order => `
        <div class="card order-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Order #${order.orderId}</h6>
                        <p class="mb-1"><strong>Customer:</strong> ${order.customerName || 'N/A'}</p>
                        <p class="mb-1"><strong>Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                        <p class="mb-1"><strong>Address:</strong> ${order.shippingAddress || 'N/A'}</p>
                        <p class="mb-1"><strong>Amount:</strong> $${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'}</p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column h-100 justify-content-between">
                            <div>
                                <span class="badge ${getStatusBadgeClass(order.status)} status-badge">
                                    ${order.status || 'UNKNOWN'}
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm w-100" onclick="assignOrder(${order.orderId})">
                                    Assign to Me
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    }

    function updateStatistics(assignedOrders, availableOrders) {
        document.getElementById('assignedCount').textContent = assignedOrders.length;
        document.getElementById('availableCount').textContent = availableOrders.length;

        const processingCount = assignedOrders.filter(order => order.status === 'PROCESSING').length;
        const deliveryCount = assignedOrders.filter(order => order.status === 'OUT_FOR_DELIVERY').length;

        document.getElementById('processingCount').textContent = processingCount;
        document.getElementById('deliveryCount').textContent = deliveryCount;
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'PENDING': return 'bg-secondary';
            case 'PROCESSING': return 'bg-warning';
            case 'OUT_FOR_DELIVERY': return 'bg-info';
            case 'DELIVERED': return 'bg-success';
            case 'CANCELLED': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function assignOrder(orderId) {
        if (confirm(`Assign order #${orderId} to yourself for processing?`)) {
            const formData = new FormData();
            formData.append('orderId', orderId);

            fetch('/delivery/assign-order', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        showAlert('Order assigned successfully!', 'success');
                        loadOrders();
                    } else {
                        showAlert('Failed to assign order.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error assigning order:', error);
                    showAlert('Error assigning order.', 'danger');
                });
        }
    }

    function updateStatus(orderId, newStatus) {
        const statusText = getStatusText(newStatus);
        if (confirm(`Update order #${orderId} status to "${statusText}"?`)) {
            const formData = new FormData();
            formData.append('orderId', orderId);
            formData.append('status', newStatus);

            fetch('/delivery/update-status', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        showAlert(`Order status updated to ${statusText}!`, 'success');
                        loadOrders();
                    } else {
                        showAlert('Failed to update order status.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                    showAlert('Error updating order status.', 'danger');
                });
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'PROCESSING': return 'Processing';
            case 'OUT_FOR_DELIVERY': return 'Out for Delivery';
            case 'DELIVERED': return 'Delivered';
            default: return status;
        }
    }

    function viewOrderDetails(orderId) {
        alert(`Viewing details for order #${orderId}\nThis would show more detailed order information.`);
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
        alertContainer.appendChild(alert);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>